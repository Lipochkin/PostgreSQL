# PostgreSQL
Домашка

Домашнее задание 5 

Настройка autovacuum с учетом особеностей производительности

Цель:

запустить нагрузочный тест pgbench

настроить параметры autovacuum

проверить работу autovacuum

Описание/Пошаговая инструкция выполнения домашнего задания:

Создать инстанс ВМ с 2 ядрами и 4 Гб ОЗУ и SSD 10GB

Установить на него PostgreSQL 15 с дефолтными настройками

Создать БД для тестов: выполнить pgbench -i postgres

Запустить pgbench -c8 -P 6 -T 60 -U postgres postgres

Применить параметры настройки PostgreSQL из прикрепленного к материалам занятия файла

Протестировать заново

Что изменилось и почему? - ***было tps = 508, tps = 400, автовакуум с новыми настройками кушает ресурсы активнее во втором случае*** 

Создать таблицу с текстовым полем и заполнить случайными или сгенерированными данным в размере 1млн строк

Посмотреть размер файла с таблицей  - ***136 MB***

5 раз обновить все строчки и добавить к каждой строчке любой символ

Посмотреть количество мертвых строчек в таблице и когда последний раз приходил автовакуум - ***не успел, автовакуум успел сработать***

Подождать некоторое время, проверяя, пришел ли автовакуум

 relname | n_live_tup | n_dead_tup | ratio% |        last_autovacuum
 
---------+------------+------------+--------+-------------------------------

 student |    1414762 |          0 |      0 | 2023-11-05 16:34:32.694833+00


5 раз обновить все строчки и добавить к каждой строчке любой символ

Посмотреть размер файла с таблицей - ***537 Mb***

Отключить Автовакуум на конкретной таблице

10 раз обновить все строчки и добавить к каждой строчке любой символ

Посмотреть размер файла с таблицей -  ***1347 MB***

Объясните полученный результат - ***все транзакции(MVCC) остались записанными и занимают место на диске плюс статистика, если сделать vacuum full размер вернется примерно к изначальному значению 136 MB***

relname | n_live_tup | n_dead_tup | ratio% |        last_autovacuum
---------+------------+------------+--------+-------------------------------

 student |     998300 |    8998483 |    901 | 2023-11-05 16:43:12.053757+00
 
Не забудьте включить автовакуум)

Задание со *:
Написать анонимную процедуру, в которой в цикле 10 раз обновятся все строчки в искомой таблице.
Не забыть вывести номер шага цикла.

